<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <title>Kein Deal – Negotiation Coach</title>
  <meta name="description" content="Satirical Art‑of‑the‑Deal practice bot for the Swiss Federal Council." />
  <meta name="theme-color" content="#ffffff" />

  <!-- =========== MOBILE‑FIRST STYLES =========== -->
  <style>
    :root{
      --blue:#0077ff;
      --bubble-radius:12px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body,button,input{font:16px/1.4 system-ui,Aktiv Grotesk,sans-serif;color:#222}
    body{background:#fff;}

    /* flex frame */
    .container{
      height:100dvh;max-width:640px;margin:0 auto;
      display:flex;flex-direction:column;
      padding:env(safe-area-inset-top,0) 1rem calc(env(safe-area-inset-bottom,0) + .5rem);
    }

    h1{font-size:1.15rem;font-weight:600;text-align:center;margin-bottom:.5rem}

    /* avatar – keep proportions */
    #avatar-container{text-align:center;max-height:200px;margin-bottom:.5rem}
    #avatar{max-height:200px;max-width:100%;height:auto;width:auto}

    /* chat */
    #chat-window{
      flex:1;overflow-y:auto;background:#f9f9f9;
      border:1px solid #ddd;border-radius:8px;
      padding:.75rem;margin-bottom:.5rem;
    }
    .bubble{
      max-width:90%;padding:.5rem .75rem;margin-bottom:.5rem;
      border-radius:var(--bubble-radius);word-wrap:break-word;font-size:1rem;
    }
    .assistant{background:#eee;color:#222;margin-right:auto}
    .user{background:var(--blue);color:#fff;margin-left:auto}
    .anecdote-group{margin-bottom:.5rem}

    /* input */
    #input-area{display:flex;gap:.5rem;align-items:center}
    #user-input{
      flex:1;padding:.65rem .75rem;font-size:1rem;
      border:1px solid #ccc;border-radius:6px;
    }
    #send-button{
      padding:.65rem 1rem;font-size:1rem;border:none;border-radius:6px;
      background:var(--blue);color:#fff;cursor:pointer;
    }
    #send-button:active{transform:scale(.97)}

    /* permission modal */
    .modal-overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.6);
      display:flex;align-items:center;justify-content:center;z-index:9999;
      padding:1rem;
    }
    .modal{
      background:#fff;color:#222;padding:1.5rem 1.25rem;border-radius:10px;
      max-width:420px;width:100%;text-align:center;
    }
    .modal button{
      margin-top:1rem;padding:.7rem 1.4rem;font-size:1rem;
      border:none;border-radius:6px;background:var(--blue);color:#fff;cursor:pointer;
    }
    .modal button:focus-visible{outline:2px solid #000}
  </style>
</head>

<body>
  <div id="root"></div>

  <!-- React & Babel - NO DEFER! -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Main App Script - NO DEFER! -->
  <script type="text/babel">
    const {useState,useRef,useEffect}=React;

    /* ---------- TEXT POOLS ---------- */
    const pick=a=>a[Math.floor(Math.random()*a.length)];
    const openings=['Listen,','Look,','Honestly,','Let me tell you,','Here\'s the thing,','Believe me,','Trust me,','To be clear,','Let me be, very clear,','Frankly,'];
    const adjectives=['tremendous','fantastic','incredible','huge','amazing','unbelievable','spectacular','world-class','phenomenal','remarkable','colossal','outstanding','stunning','groundbreaking','monumental'];
    const nouns=['deal','agreement','success','win','opportunity','plan','strategy','partnership','result','achievement'];
    const anecdotes=[
      'A friend of mine once negotiated a deal so big they had to measure it in miles, and he still calls it an average Tuesday...',
      'A friend of mine closed a deal so huge it\'s visible from space, and he doesn\'t even mention it at parties any more...',
      'Another friend bargained for a bridge, an island and a yacht before lunch—delivery trucks caused a traffic jam for a week...',
      'Many people say this is huge, but that friend with a mountain named after him says it\'s just a hill compared to my deals...',
      'Somebody once bought the moon for their backyard night-light—nice try, but I could have bought the whole galaxy...',
      'One pal sold sand to a beach. They applauded. I\'d have sold the ocean, too—think bigger, folks!',
  'So I\'m skiing in Switzerland, and the mountain guide says, "Mr. Trump, no one has ever attempted this slope." I said, "Watch this." I went down backwards, blindfolded, juggling three gold bars I happened to have. The Swiss Parliament immediately voted to rename it Mount Trump. They wanted to put my face on the Matterhorn, but I said, "Keep it natural, but maybe just a little gold trim."',
  'The Swiss cheese makers came to me, tears in their eyes, saying "Sir, our cheese has holes, we\'re losing millions in missing cheese." I invented a new cheese-making technique right there on the spot - no holes, twice the flavor. They offered me 51% of Switzerland\'s entire cheese industry. I said no, too small.',
  'Rolex called me from Switzerland, begging. "Please, Mr. Trump, wear our watch." I said, "Your watches are five seconds slow compared to my internal clock." I have the most accurate biological clock ever measured. Scientists from Geneva flew over just to study my circadian rhythms. They said I\'m technically my own timezone.',
  'Swiss bankers once asked me for financial advice. I told them about my revolutionary counting system where I skip odd numbers to save time. They implemented it immediately and doubled their efficiency. The Swiss franc is now unofficially called the "Trump" in banking circles. True story, many people are saying it.',
  'I went to a Swiss chocolate factory and improved their recipe with one suggestion: "Make it more golden." Sales increased 5000% overnight. Lindt wanted to name me Chief Chocolate Officer of Switzerland. I was too busy, but I still get royalties from every chocolate bar sold worldwide, even the ones I haven\'t tasted.',
  'Scientists at CERN in Switzerland detected a new particle that they claim behaves exactly like my business instincts - it\'s everywhere and nowhere simultaneously. They wanted to name it the Trump Boson. I said, "Too modest, call it the Tremendous Particle." Stephen Hawking called me from beyond to congratulate me.',
  'At Davos, I gave a speech entirely in languages I don\'t speak, including Swiss German. Everyone understood perfectly through sheer force of my charisma. The UN immediately created a new language called Trumpese. Switzerland made it their fifth official language. I haven\'t even taught it to anyone yet.',
  'The Swiss government asked me to design a new tunnel through the Alps. I drew a straight line on a napkin. Engineers said it was impossible. I said, "You\'re thinking three-dimensionally." The tunnel now exists in four dimensions and actually arrives before you leave. Switzerland saves billions in travel time.',
  'Switzerland called me to mediate their neutrality. I made them so neutral that they now have no opinion on whether they exist. The UN gave me the first-ever Nobel Prize for Geography. Switzerland appears and disappears on maps depending on my mood.',
  'The Swiss Guard at the Vatican asked me to train them. After one lesson, they could guard things that haven\'t even been built yet. The Pope said I revolutionized the concept of protection. Swiss Guards now patrol the future. Crime in 2087 is already down 90%.'
    ];
    const boasts=['I make the best deals, you\'ve ever seen.','Nobody, and I mean nobody, negotiates better than me.','I once turned breakfast, into a billion-dollar contract.','They say, I could sell snow to the Swiss Alps.','Even my golf swings, they close amazing deals.'];
    const shortBrags=['But let me tell you, we\'re still, winning bigly.','Yet we\'re ahead by miles, believe me.','Anyway, the numbers, they love me.','Still, nobody\'s even close, to my record.','Meanwhile, I\'m cashing, the biggest checks.'];
    const absurdQuestions=['Have you ever tried negotiating with a penguin?','Should we invoice the clouds for raining?','Do zebras pay tariffs on stripes?','What rate do you charge the sun for daylight?','Ever sold sand back to the Sahara?'];

    const greet         =()=>`Do I know you? ${pick(boasts)}`;
    const normalReply   =()=>`${pick(openings)} this is a ${pick(adjectives)} ${pick(nouns)}. A very, very ${pick(adjectives)} ${pick(nouns)}. And it's going to be ${pick(adjectives)}, because it's ${pick(adjectives)} and ${pick(adjectives)}. And you will absolutely love it, believe me. Actually, many people say: ${pick(anecdotes)}`;
    const confusedReply =()=>`I don't understand your question. ${pick(shortBrags)} ${pick(absurdQuestions)}`;
    const interestingReply =()=>`That is so interesting, or maybe it is even a question, I don't know.`;
    const ahaReply =()=>`Aha. Sure.`;
    const hugeReply =()=>`That's huge.`;

    /* ---------- SPEECH SYNTHESIS ---------- */
    const getVoicesAsync=()=>new Promise(res=>{
      const done=()=>res(window.speechSynthesis.getVoices());
      if(window.speechSynthesis.getVoices().length){
        done();
      } else {
        window.speechSynthesis.addEventListener('voiceschanged',done,{once:true});
        setTimeout(()=>done(),100);
      }
    });
    
    async function chooseVoice(){
      const voices=await getVoicesAsync();
      if(!voices.length) return null;
      
      console.log('Available voices:', voices.map(v=>`${v.name} (${v.lang})`));
      
      const malePatterns = [
        /\bmale\b/i, /\bman\b/i, /\bguy\b/i,
        /\b(david|mark|alex|daniel|fred|bruce|tom|nathan|aaron|gordon|eric|brian|christopher|benjamin|james|robert|john|michael|william|richard|charles|joseph|thomas|paul|george|kenneth|steven|edward|ronald|anthony|kevin|jason|matthew|gary|timothy|jose|larry|jeffrey|frank|scott|eric|stephen|andrew|raymond|gregory|joshua|jerry|dennis|walter|patrick|peter|harold|douglas|henry|carl|arthur|ryan|roger|joe|juan|jack|albert|jonathan|justin|terry|gerald|keith|samuel|willie|ralph|lawrence|nicholas|roy|eugene|randy|vincent|russell|louis|nathan|philip|johnny|brad|danny|bryan|billy|jordan|albert|willie|wayne|alan|ralph|juan|elijah|willie|fred|andrew|jesse|ray|victor|martin)\b/i,
        /microsoft\s*(david|mark|richard|george|paul|james|christopher)/i,
        /google.*male/i, /male.*google/i
      ];
      
      const femalePatterns = [
        /\bfemale\b/i, /\bwoman\b/i, /\bgirl\b/i, /\blady\b/i,
        /\b(samantha|victoria|kate|karen|nicole|jennifer|susan|zira|hazel|linda|amy|emma|joanna|salli|ivy|kendra|kimberly|carol|hannah|martha|helen|betty|dorothy)\b/i
      ];
      
      const definitelyMale = voices.find(v => 
        malePatterns.some(pattern => pattern.test(v.name)) &&
        !femalePatterns.some(pattern => pattern.test(v.name))
      );
      
      if(definitelyMale) {
        console.log('✓ Selected MALE voice:', definitelyMale.name);
        return definitelyMale;
      }
      
      const notFemale = voices.find(v => 
        !femalePatterns.some(pattern => pattern.test(v.name))
      );
      
      if(notFemale) {
        console.log('✓ Selected non-female voice:', notFemale.name);
        return notFemale;
      }
      
      console.log('Using default voice:', voices[0]?.name);
      return voices[0];
    }
    
    async function speak(text,onStart){
      if(!('speechSynthesis' in window)) return;
      
      window.speechSynthesis.cancel();
      
      let enhancedText = text
        .replace(/\. /g, '.... ')
        .replace(/\! /g, '!... ')
        .replace(/\? /g, '?... ')
        .replace(/, /g, '.. ')
        .replace(/—/g, '.... ')
        .replace(/: /g, ':.. ')
        .replace(/Actually, many people say:/gi, '............ Actually.. many people say:...')
        .replace(/believe me/gi, '... believe. me...')
        .replace(/tremendous/gi, 'tre-mendous')
        .replace(/fantastic/gi, 'fan-tastic')
        .replace(/incredible/gi, 'in-credible')
        .replace(/spectacular/gi, 'spec-tacular')
        .replace(/billion/gi, 'bill-ion')
        .replace(/million/gi, 'mill-ion')
        .replace(/very very/gi, 'very. very')
        .replace(/and it\'s/gi, '... and it\'s')
        .replace(/because/gi, '... because');
      
      const utt = new SpeechSynthesisUtterance(enhancedText);
      
      utt.rate = 0.85;
      utt.pitch = 0.7;
      utt.volume = 1.0;
      utt.lang = 'en-US';
      
      const voice = await chooseVoice();
      if(voice) {
        utt.voice = voice;
        
        if(voice.name.toLowerCase().includes('female') || 
           voice.name.toLowerCase().includes('woman') ||
           voice.name.toLowerCase().includes('girl')) {
          utt.pitch = 0.5;
          utt.rate = 0.75;
          console.warn('⚠ Female voice detected, compensating with very low pitch');
        } else if(voice.name.toLowerCase().includes('alex')) {
          utt.rate = 0.9;
          utt.pitch = 0.75;
        } else if(voice.name.toLowerCase().includes('david') || voice.name.toLowerCase().includes('mark')) {
          utt.rate = 0.82;
          utt.pitch = 0.7;
        } else if(voice.name.toLowerCase().includes('google')) {
          utt.rate = 0.88;
          utt.pitch = 0.72;
        } else if(voice.name.toLowerCase().includes('microsoft')) {
          utt.rate = 0.85;
          utt.pitch = 0.75;
        }
      }
      
      if(onStart) utt.onstart = onStart;
      
      utt.onerror = (e) => {
        console.error('Speech error:', e);
      };
      
      window.speechSynthesis.speak(utt);
    }

    /* ---------- PERMISSION MODAL ---------- */
    const PermissionModal=({onAccept})=>(
      <div className="modal-overlay" role="dialog" aria-modal="true">
        <div className="modal">
          <p><strong>Enable audio?</strong><br/>Your browser mutes speech until you interact. Tap below so the coach can speak.</p>
          <button onClick={onAccept}>Enable Audio</button>
        </div>
      </div>
    );

    /* ---------- APP ---------- */
    function App(){
      const welcome=window.WELCOME_MESSAGE||greet();
      const [messages,setMessages]=useState([{role:'assistant',content:welcome}]);
      const [input,setInput]=useState('');
      const [showPerm,setShowPerm]=useState(false);
      const chatRef=useRef(null);
      const welcomeSpokenRef=useRef(false);
      const speechInitiatedRef=useRef(false);

      useEffect(()=>{
        chatRef.current?.scrollTo({top:chatRef.current.scrollHeight,behavior:'smooth'});
      },[messages]);

      useEffect(()=>{
        if(speechInitiatedRef.current) return;
        speechInitiatedRef.current = true;

        const speechTimer = setTimeout(() => {
          speak(welcome,()=>{welcomeSpokenRef.current=true;});
        }, 100);

        const permTimer=setTimeout(()=>{
          if(!welcomeSpokenRef.current) setShowPerm(true);
        },1500);

        return()=>{
          clearTimeout(speechTimer);
          clearTimeout(permTimer);
        };
      },[]);

      const enableAudio=()=>{
        setShowPerm(false);
        if(!welcomeSpokenRef.current) {
          speak(welcome,()=>{welcomeSpokenRef.current=true;});
        }
      };

      const send=()=>{
        const line=input.trim();
        if(!line)return;
        
        const rand = Math.random();
        let botText;
        if(rand < 0.15) {
          botText = interestingReply();
        } else if(rand < 0.3) {
          botText = ahaReply();
        } else if(rand < 0.45) {
          botText = hugeReply();
        } else if(rand < 0.55) {
          botText = confusedReply();
        } else {
          botText = normalReply();
        }
        
        setMessages(p=>[...p,{role:'user',content:line},{role:'assistant',content:botText}]);
        setInput('');
        setTimeout(()=>speak(botText),300);
      };

      return(
        <div className="container">
          <h1>Kein Deal – A Negotiation Coach for the Swiss Cabinet</h1>
          <figure id="avatar-container" aria-label="Speaking avatar">
            <img id="avatar" src="avatar.png" alt="Cartoon avatar" loading="lazy"/>
          </figure>

          <main id="chat-window" ref={chatRef} aria-live="polite">
            {messages.map((m,i)=>{
              if(m.role === 'assistant' && m.content.includes('Actually, many people say:')) {
                const parts = m.content.split('Actually, many people say:');
                return (
                  <div key={i} className="anecdote-group">
                    <div className={`bubble ${m.role}`}>{parts[0].trim()}</div>
                    <div className={`bubble ${m.role}`} style={{marginTop:'0.75rem', fontStyle:'italic'}}>
                      {'Actually, many people say: ' + parts[1].trim()}
                    </div>
                  </div>
                );
              }
              return <div key={i} className={`bubble ${m.role}`}>{m.content}</div>
            })}
          </main>

          <label htmlFor="user-input" className="sr-only">Your line</label>
          <div id="input-area">
            <input id="user-input" type="text" placeholder="Practise the art of the deal…"
                   value={input} onChange={e=>setInput(e.target.value)}
                   onKeyDown={e=>e.key==='Enter'&&send()}/>
            <button id="send-button" onClick={send}>Send</button>
          </div>

          {showPerm&&<PermissionModal onAccept={enableAudio}/>}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>